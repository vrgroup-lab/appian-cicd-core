name: Promote Appian Package (reusable)

on:
  workflow_call:
    inputs:
      source_env:
        description: "Origen (dev|qa|demo)"
        required: true
        type: string
      target_env:
        description: "Destino (qa|prod|demo)"
        required: true
        type: string
      artifact_name:
        description: "Nombre del artifact a descargar"
        required: true
        type: string
      data_source:
        description: "Nombre/UUID del data source para ejecutar scripts de base de datos (opcional)"
        required: false
        type: string

permissions:
  contents: read
  actions: read

jobs:
  promote:
    name: Promote package
    runs-on: ubuntu-latest
    environment: ${{ inputs.target_env }}
    steps:
      - name: Resolver API key (target)
        shell: bash
        run: |
          set -euo pipefail
          tgt="${{ inputs.target_env }}"; tgt_lc="${{ inputs.target_env }}"; tgt_lc="${tgt_lc,,}"
          case "$tgt_lc" in
            dev)  echo "APPIAN_API_KEY_TARGET=${{ secrets.APPIAN_DEV_API_KEY }}" >> "$GITHUB_ENV" ;;
            qa)   echo "APPIAN_API_KEY_TARGET=${{ secrets.APPIAN_QA_API_KEY }}" >> "$GITHUB_ENV" ;;
            prod) echo "APPIAN_API_KEY_TARGET=${{ secrets.APPIAN_PROD_API_KEY }}" >> "$GITHUB_ENV" ;;
            demo) echo "APPIAN_API_KEY_TARGET=${{ secrets.APPIAN_DEMO_API_KEY }}" >> "$GITHUB_ENV" ;;
            *) echo "::error::Entorno target no soportado: $tgt"; exit 1 ;;
          esac
          echo "APPIAN_TARGET_ENV=$tgt" >> "$GITHUB_ENV"

      - name: Descargar artifact por nombre
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: downloaded

      - name: Descargar scripts de base de datos (si existen)
        uses: actions/download-artifact@v4
        with:
          name: ${{ format('{0}-db-scripts', inputs.artifact_name) }}
          path: db-scripts
        continue-on-error: true

      - name: Resolver ruta del paquete
        id: resolve_pkg
        shell: bash
        run: |
          set -euo pipefail
          found=$(find downloaded -type f -name '*.zip' -print -quit)
          if [[ -z "$found" ]]; then
            echo "::error::No se pudo resolver 'package_path' a partir del artifact descargado. Verifique 'artifact_name'."
            exit 1
          fi
          echo "path=$found" >> "$GITHUB_OUTPUT"

      - name: Resolver scripts de base de datos
        id: resolve_db_scripts
        shell: bash
        run: |
          set -euo pipefail
          dir="db-scripts"
          if [ ! -d "$dir" ]; then
            exit 0
          fi
          first=$(find "$dir" -type f \( -iname '*.sql' -o -iname '*.ddl' \) -print -quit || true)
          if [ -z "$first" ]; then
            exit 0
          fi
          abs_dir="$(cd "$dir" && pwd)"
          echo "path=$abs_dir" >> "$GITHUB_OUTPUT"

      - name: Promover paquete
        uses: vrgroup-lab/appian-cicd-core/.github/actions/appian-promote@icfbuild
        with:
          source_env: ${{ inputs.source_env }}
          target_env: ${{ inputs.target_env }}
          package_path: ${{ steps.resolve_pkg.outputs.path }}
          data_source: ${{ inputs.data_source }}
          db_scripts_path: ${{ steps.resolve_db_scripts.outputs.path }}

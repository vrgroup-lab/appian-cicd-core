name: Promote

on:
  workflow_call:
    inputs:
      target-env:     { required: true, type: string }
      package-path:   { required: true, type: string }
      poll-timeout-sec: { required: false, type: number }
      poll-interval-sec: { required: false, type: number }
    secrets:
      APPIAN_API_KEY: { required: true }

jobs:
  promote:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Resolve target URL
        id: resolve
        run: |
          echo "url=$(./scripts/resolve_env_url.sh '${{ inputs.target-env }}')" >> "$GITHUB_OUTPUT"
      - name: Promote package to Appian
        uses: ./.github/actions/promote
        with:
          base-url: ${{ steps.resolve.outputs.url }}
          api-key: ${{ secrets.APPIAN_API_KEY }}
          package-path: ${{ inputs.package-path }}
          poll-timeout-sec: ${{ inputs['poll-timeout-sec'] }}
          poll-interval-sec: ${{ inputs['poll-interval-sec'] }}

      # (opcional) Smoke ping sin exponer valores
      # - name: Smoke ping deployments (optional)
      #   env:
      #     URL: ${{ inputs.appian_url }}
      #     KEY: ${{ secrets.APPIAN_API_KEY }}
      #   run: |
      #     set -e
      #     CODE=$(curl -sS -o /dev/null -w "%{http_code}" \
      #       -H "appian-api-key: $KEY" "$URL/suite/deployment/v1/deployments")
      #     echo "HTTP $CODE (expected 200/401/403)"

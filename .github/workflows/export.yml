name: Export

on:
  workflow_call:
    inputs:
      base-url:       { required: true, type: string }
      export-type:    { required: true, type: string }
      app-uuid:       { required: true, type: string }
      package-name:   { required: false, type: string }
      name:           { required: false, type: string }
      description:    { required: false, type: string }
      poll-timeout-sec: { required: false, type: number }
      poll-interval-sec: { required: false, type: number }
      download-out:   { required: false, type: string }
    secrets:
      APPIAN_API_KEY: { required: true }

jobs:
  export:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Validaciones mínimas (sin lógica real aún)
      - name: Validate inputs
        shell: bash
        run: |
          set -euo pipefail
          [[ -f "${{ inputs.manifest_path }}" ]] || { echo "Manifest not found: ${{ inputs.manifest_path }}"; exit 1; }
          if [[ "${{ inputs.export_scope }}" == "package" && -z "${{ inputs.package_name }}" ]]; then
            echo "package_name is required when export_scope=package"; exit 1;
          fi

      - name: Wire check (export)
        env:
          URL: ${{ inputs.appian_url }}
          PUBLIC_JSON: ${{ inputs.app_props_public_json }}
        run: |
          echo "[core/export] MANIFEST=${{ inputs.manifest_path }}"
          echo "[core/export] SCOPE=${{ inputs.export_scope }}"
          echo "[core/export] PACKAGE=${{ inputs.package_name }}"
          echo "[core/export] URL=${URL}"
          echo "[core/export] PUBLIC_JSON length=${#PUBLIC_JSON}"
          echo "[core/export] Secrets wired (API_KEY + SENSITIVE_JSON)"
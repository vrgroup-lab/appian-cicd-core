name: Export Appian Package (reusable)

on:
  workflow_call:
    inputs:
      env:
        description: "Entorno Appian (dev|qa|prod|demo)"
        required: true
        type: string
      deploy_kind:
        description: "Tipo de despliegue (app|package)"
        required: true
        type: string
      app_uuid:
        description: "UUID de la aplicación origen"
        required: true
        type: string
      app_name:
        description: "Nombre de la aplicación"
        required: false
        type: string
      package_name:
        description: "Nombre del paquete (para resolver UUID si no se entrega)"
        required: false
        type: string
    outputs:
      artifact_path:
        description: "Ruta del artefacto exportado"
        value: ${{ jobs.export.outputs.artifact_path }}
      artifact_name:
        description: "Nombre del artifact subido (para descargar en promote)"
        value: ${{ jobs.export.outputs.artifact_name }}
      artifact_dir:
        description: "Carpeta base donde se descargaron los recursos"
        value: ${{ jobs.export.outputs.artifact_dir }}
      manifest_path:
        description: "Ruta relativa al manifest generado por la exportación"
        value: ${{ jobs.export.outputs.manifest_path }}
      raw_response_path:
        description: "Ruta relativa a la respuesta cruda almacenada en disco"
        value: ${{ jobs.export.outputs.raw_response_path }}
      deployment_uuid:
        description: "UUID del deployment de exportación en Appian"
        value: ${{ jobs.export.outputs.deployment_uuid }}
      deployment_status:
        description: "Estado terminal informado por Appian para la exportación"
        value: ${{ jobs.export.outputs.deployment_status }}

permissions:
  contents: read
  actions: write

jobs:
  export:
    name: Export package
    runs-on: ubuntu-latest
    outputs:
      artifact_path: ${{ steps.export.outputs.artifact_path }}
      artifact_name: ${{ steps.meta.outputs.artifact_name }}
      artifact_dir: ${{ steps.export.outputs.artifact_dir }}
      manifest_path: ${{ steps.export.outputs.manifest_path }}
      raw_response_path: ${{ steps.export.outputs.raw_response_path }}
      deployment_uuid: ${{ steps.export.outputs.deployment_uuid }}
      deployment_status: ${{ steps.export.outputs.deployment_status }}
    steps:
      - name: Resolver API key por entorno
        id: resolve
        shell: bash
        run: |
          set -euo pipefail
          env_in="${{ inputs.env }}"; env_lc="${{ inputs.env }}"; env_lc="${env_lc,,}"
          case "$env_lc" in
            dev)
              echo "APPIAN_API_KEY=${{ secrets.APPIAN_DEV_API_KEY }}" >> "$GITHUB_ENV" ;;
            qa)
              echo "APPIAN_API_KEY=${{ secrets.APPIAN_QA_API_KEY }}" >> "$GITHUB_ENV" ;;
            prod)
              echo "APPIAN_API_KEY=${{ secrets.APPIAN_PROD_API_KEY }}" >> "$GITHUB_ENV" ;;
            demo)
              echo "APPIAN_API_KEY=${{ secrets.APPIAN_DEMO_API_KEY }}" >> "$GITHUB_ENV" ;;
            *)
              echo "::error::Entorno no soportado: $env_in (use dev|qa|prod|demo)"; exit 1 ;;
          esac
          echo "APPIAN_ENV=$env_in" >> "$GITHUB_ENV"

      # Nota: APPIAN_BASE_URL se resuelve dentro de la composite action utilizando
      # un archivo de configuración versionado en el Core.

      - name: Resolver recurso a exportar
        id: res
        shell: bash
        run: |
          set -euo pipefail
          kind="${{ inputs.deploy_kind }}"; kind_lc="${{ inputs.deploy_kind }}"; kind_lc="${kind_lc,,}"
          case "$kind_lc" in
            app)
              echo "kind=app" >> "$GITHUB_OUTPUT"
              echo "id=${{ inputs.app_uuid }}" >> "$GITHUB_OUTPUT" ;;
            package)
              echo "kind=package" >> "$GITHUB_OUTPUT"
              echo "need_resolve=true" >> "$GITHUB_OUTPUT" ;;
            *) echo "::error::deploy_kind inválido: $kind (use app|package)"; exit 1 ;;
          esac

      - name: Resolver package UUID por nombre (MVP)
        id: pkg
        if: ${{ steps.res.outputs.kind == 'package' && steps.res.outputs.need_resolve == 'true' }}
        uses: vrgroup-lab/appian-cicd-core/.github/actions/appian-resolve-package@develop
        with:
          env_name: ${{ inputs.env }}
          app_uuid: ${{ inputs.app_uuid }}
          package_name: ${{ inputs.package_name }}

      - name: Resolver ID final
        id: rid
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${{ steps.res.outputs.id }}" ]; then
            echo "id=${{ steps.res.outputs.id }}" >> "$GITHUB_OUTPUT"
          else
            echo "id=${{ steps.pkg.outputs.package_uuid }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Exportar recurso (MVP)
        id: export
        uses: vrgroup-lab/appian-cicd-core/.github/actions/appian-export@icfbuild
        with:
          env_name: ${{ inputs.env }}
          resource_kind: ${{ steps.res.outputs.kind }}
          resource_id: ${{ steps.rid.outputs.id }}
          display_name: ${{ inputs.package_name }}

      - name: Definir nombre de artifact
        id: meta
        shell: bash
        run: |
          set -euo pipefail
          artifact_path='${{ steps.export.outputs.artifact_path }}'
          if [ -z "$artifact_path" ]; then
            echo "::error::artifact_path vacío; revisar salida de appian-export."
            exit 1
          fi
          # Nombre estable que funciona tanto para app como package
          nm_part='${{ inputs.package_name }}'
          if [ -z "$nm_part" ]; then nm_part='${{ steps.rid.outputs.id }}'; fi
          app_part='${{ inputs.app_name }}'
          if [ -z "$app_part" ]; then app_part='app'; fi
          safe_app=$(echo "$app_part" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9._-' '-')
          if [ -z "$safe_app" ]; then safe_app='app'; fi
          safe_nm=$(echo "$nm_part" | tr '[:upper:]' '[:lower:]' | tr -cs 'a-z0-9._-' '-')
          if [ -z "$safe_nm" ]; then safe_nm='pkg'; fi
          name="appian-${safe_app}-${{ inputs.deploy_kind }}-${safe_nm}-${{ github.run_id }}"
          if [ -z "$name" ]; then
            name=$(basename "$artifact_path")
            if [ -z "$name" ]; then
              echo "::error::No se pudo resolver artifact_name a partir de artifact_path ($artifact_path)."
              exit 1
            fi
          fi
          echo "artifact_name=$name" >> "$GITHUB_OUTPUT"

      - name: Subir paquete exportado (ZIP)
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_name }}
          path: ${{ steps.export.outputs.artifact_path }}
          if-no-files-found: error
          retention-days: 5

      - name: Subir metadata de exportación
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_name }}-meta
          path: |
            ${{ steps.export.outputs.manifest_path }}
            ${{ steps.export.outputs.raw_response_path }}
          if-no-files-found: error
          retention-days: 5

      - name: Subir scripts de base de datos
        if: ${{ steps.export.outputs.artifact_dir != '' && hashFiles(format('{0}/db-scripts/**', steps.export.outputs.artifact_dir)) != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_name }}-db-scripts
          path: ${{ steps.export.outputs.artifact_dir }}/db-scripts
          if-no-files-found: error
          retention-days: 5

      - name: Subir customization file
        if: ${{ steps.export.outputs.artifact_dir != '' && hashFiles(format('{0}/customization/customization.properties', steps.export.outputs.artifact_dir)) != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_name }}-customization
          path: ${{ steps.export.outputs.artifact_dir }}/customization/customization.properties
          if-no-files-found: error
          retention-days: 5

      - name: Subir customization template
        if: ${{ steps.export.outputs.artifact_dir != '' && hashFiles(format('{0}/customization/customization-template.properties', steps.export.outputs.artifact_dir)) != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_name }}-customization-template
          path: ${{ steps.export.outputs.artifact_dir }}/customization/customization-template.properties
          if-no-files-found: error
          retention-days: 5

      - name: Subir plugins ZIP
        if: ${{ steps.export.outputs.artifact_dir != '' && hashFiles(format('{0}/plugins/plugins.zip', steps.export.outputs.artifact_dir)) != '' }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.meta.outputs.artifact_name }}-plugins
          path: ${{ steps.export.outputs.artifact_dir }}/plugins/plugins.zip
          if-no-files-found: error
          retention-days: 5

# Deployment Pipeline

This pipeline promotes Appian packages across environments using reusable workflows.

Actors and triggers
- Wrapper repo: triggers Core workflows via `workflow_call`.
- Manual dispatch in wrapper: chooses `deploy_kind`, `app_uuid`, `package_name`, and plan (Dev→QA, Dev→Prod, Dev→QA→Prod).
- Environment approvals: enforced in the wrapper using GitHub Environments (`environment: <target_env>`).

Artifacts
- Export ZIP name: generated by Core export action and uploaded as an artifact.
- Artifact naming in workflow: `appian-<deploy_kind>-<app_uuid>-<nm>-<run_id>` where `<nm>` is `package_name` or the resolved UUID. See `.github/workflows/export.yml`.

Step-by-step
- Export job (`.github/workflows/export.yml`):
  - Resolve API key for `inputs.env` from secrets.
  - Optionally resolve package UUID from name using `.github/actions/appian-resolve-package`.
  - Call `.github/actions/appian-export` to export (dry-run supported for testing).
  - Upload ZIP as artifact and expose `artifact_name`.
- Promote job (`.github/workflows/promote.yml`):
  - Resolve `APPIAN_API_KEY_TARGET` per `target_env` secrets and set `environment: <target_env>`.
  - Download artifact by `artifact_name` and resolve `package_path`.
  - Optionally inspect (`APPIAN_PROMOTE_ENABLE_INSPECTION=true`), then import using `.github/actions/appian-promote`.

State machine and retries
- Inspection (`inspect_cli.py`):
  - Polls GET `/inspections/{uuid}` until `COMPLETED` or `FAILED`.
  - Retries on 404 (registration lag), 500 `APNX-1-4552-005` (no info yet), or transient network errors, bounded by `APPIAN_PROMOTE_INSPECTION_RETRIES` and `APPIAN_PROMOTE_MAX_WAIT`.
- Import (`import_cli.py`):
  - Polls GET `/deployments/{uuid}` until one of: `COMPLETED`, `COMPLETED_WITH_ERRORS`, `COMPLETED_WITH_IMPORT_ERRORS`, `COMPLETED_WITH_PUBLISH_ERRORS`, `FAILED`, `PENDING_REVIEW`, `REJECTED`.
  - POST import retries on transient errors (HTTP 500, timeouts) based on `APPIAN_PROMOTE_IMPORT_RETRIES` and `APPIAN_PROMOTE_RETRY_DELAY`.
- Export (`appian-export/appian_cli.py`):
  - Polls until `COMPLETED` or `COMPLETED_WITH_EXPORT_ERRORS` or `FAILED`.
  - Attempts multiple known download URLs when `results.packageZip` is missing.

Configuration knobs
- `.github/actions/_config/appian_promote.env` controls inspection enablement.
- Poll intervals and timeouts via env vars (see CONFIGURATION.md).


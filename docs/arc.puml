@startuml
' Layout & legibilidad
left to right direction
skinparam shadowing false

skinparam defaultFontName Monospace
skinparam linetype ortho

node "GitHub" as GH {
  rectangle "Repos de Aplicación" as GH_APPS {
    node "Repo App A" as GH_A {
      artifact "deploy.yml (wrapper)" as D_A
    }
    GH_A -[hidden]down- RepoAppB
    node "Repo App B" as RepoAppB {
      artifact "deploy.yml (wrapper)" as D_B
    }
    RepoAppB -[hidden]down- RepoAppN
    node "Repo App N" as RepoAppN {
      artifact "deploy.yml (wrapper)" as D_N
    }
  }

  node "Repo Core" as GH_CORE {
    package "Workflows Core" as COREPKG {
      artifact "export.yml"  as WF_EXPORT
      artifact "promote.yml" as WF_PROMOTE
      note bottom of WF_PROMOTE
        Orquesta internamente inspect.yml e import.yml
      end note
    }
    artifact "CoreLib" as CORELIB
  }

  GH_APPS -[hidden]- GH_CORE
}

node "AWS" as AWS {
  node "IAM (OIDC / STS)" as IAM
  node "API Gateway" as APIGW
  node "Lambda (Secrets Broker)" as LMB
  database "Secrets Manager\nappian/{env}/*" as SM
}

node "Appian Cloud" as APPCLOUD {
  node "Dev"  as DEV
  node "QA"   as QA
  node "Prod" as PROD
  component "Deployment APIs v2" as APIDEV2
}

' ==== Flujos ====
D_A --> COREPKG : workflow_call
D_B --> COREPKG : workflow_call
D_N --> COREPKG : workflow_call
COREPKG ..> CORELIB : dependencia (reuse)

COREPKG --> IAM : AssumeRoleWithWebIdentity
COREPKG --> APIGW : HTTPS (signed/bearer)
APIGW --> LMB : invoke
LMB --> SM : GetSecretValue
SM --> LMB
LMB --> APIGW
APIGW --> COREPKG : secrets (memoria)

COREPKG --> APIDEV2 : export/inspect/import
APIDEV2 --> DEV
APIDEV2 --> QA
APIDEV2 --> PROD

' Título
title **Arquitectura CI/CD Appian – Vista general**

' Leyenda
legend right
  Rectángulos = Nodos/servicios
  Artifact = Workflows YAML en GitHub
  Cilindro = Secrets Manager
  Flecha punteada = Dependencia
endlegend

@enduml